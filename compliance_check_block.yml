# compliance_check_block.yml
# This file contains the block of tasks for each compliance check item.

- name: Run Check Command for Control {{ item.control_id }}
  shell: "{{ item.check_command }}"
  register: check_result
  failed_when: false
  changed_when: false

- name: Command Output for {{ item.control_id }}
  debug:
    msg: |
      Control ID: {{ item.control_id }}
      Description: {{ item.description }}
      Check Command: {{ item.check_command }}
      Expected Result: {{ item.expected_result | default('N/A') }}
      Actual Result: {{ check_result.stdout | trim }}
      Exit Code: {{ check_result.rc }}

- name: Determine Compliance Status for {{ item.control_id }}
  set_fact:
    compliance_status: >-
      {% if item.expected_result is defined and item.expected_result | length > 0 %}
        {{ (check_result.stdout | trim == item.expected_result) | ternary('COMPLIANT', 'NON_COMPLIANT') }}
      {% else %}
        {{ (check_result.rc == 0) | ternary('COMPLIANT', 'NON_COMPLIANT') }}
      {% endif %}

- name: Add Result to Compliance Report
  set_fact:
    compliance_report: >-
      {{ compliance_report + [{
        'control_id': item.control_id,
        'category': item.category,
        'description': item.description,
        'check_command': item.check_command,
        'expected_result': item.expected_result,
        'actual_result': check_result.stdout | trim,
        'exit_code': check_result.rc,
        'status': compliance_status | trim,
        'remediable': item.remediable,
        'remediation_command': item.remediation_command
      }] }}
